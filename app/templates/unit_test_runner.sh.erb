set -x
MASTER_NOVA_URL=<%= ENV['NOVA_GIT_MASTER'] %>
MASTER_GLANCE_URL=<%= ENV['GLANCE_GIT_MASTER'] %>
MASTER_KEYSTONE_URL=<%= ENV['KEYSTONE_GIT_MASTER'] %>

TMP_DIR=$(mktemp -d)
#
function setup {
	cd $TMP_DIR
	if [ -n "$NOVA_URL" ]; then
		if [[ ${NOVA_URL:0:2} == "lp" ]]; then
			get_nova_source_bzr
		else	
			get_nova_source_git
		fi
	fi

	if [ -n "$KEYSTONE_URL" ]; then
		if [[ ${KEYSTONE_URL:0:2} == "lp" ]]; then
			get_keystone_source_bzr
		else	
			get_keystone_source_git
		fi
	fi

	if [ -n "$GLANCE_URL" ]; then
		if [[ ${GLANCE_URL:0:2} == "lp" ]]; then
			get_glance_source_bzr
		else	
			get_glance_source_git
		fi
	fi
}

function is_master {
  if [ ["$1" -eq "$2"] -a ["$3" -eq "master"] ]; then
    return 1
  else
    return 0
  fi
}

function run_job {

trap "{ cd /tmp; rm -Rf $TMP_DIR; }" INT TERM EXIT
export PIP_DOWNLOAD_CACHE="~/.pip/unittest_runner_cache"
return_code=0
tests_run=0
return_msg=""

#nova_master=is_master "$NOVA_URL" "$MASTER_NOVA_URL" "$NOVA_BRANCH"
#nova_master=0
if ! is_master "$NOVA_URL" "$MASTER_NOVA_URL" "$NOVA_BRANCH"; then
#if [ $nova_master -ne 1 ]; then
  tests_run=1
  cd $TMP_DIR/nova_source
  ./run_tests.sh -V -f 1>nova.out.log
  nova_status=$?
  ./run_tests.sh -V -p 1>nova_pep8.out.log
  nova_pep8_status=$?
  if [ "$nova_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}nova tests failed "
     grep "Creating venv... done." -m 1 -h -A`wc -l nova.out.log | cut -d' ' -f1` nova.out.log
  fi
  
  if [ "$nova_pep8_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}nova pep8 failed "
     grep "Running pep8" -m 1 -h -A`wc -l nova_pep8.out.log | cut -d' ' -f1` nova_pep8.out.log
  fi
fi

if ! is_master "$GLANCE_URL" "$MASTER_GLANCE_URL" "$GLANCE_BRANCH"; then
#glance_master=is_master "$GLANCE_URL" "$MASTER_GLANCE_URL" "$GLANCE_BRANCH"
#glance_master=0
#if [ $glance_master -ne 1 ]; then
  tests_run=1
  cd $TMP_DIR/glance_source
  ./run_tests.sh -V -f 1>glance.out.log
  glance_status=$?
  ./run_tests.sh -V -p 1>glance_pep8.out.log
  glance_pep8_status=$?
  if [ "$glance_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}glance tests failed "
     grep "Creating venv... done." -m 1 -h -A`wc -l glance.out.log | cut -d' ' -f1` glance.out.log
  fi
  
  if [ "$glance_pep8_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}glance pep8 failed "
     grep "Running pep8" -m 1 -h -A`wc -l glance_pep8.out.log | cut -d' ' -f1` glance_pep8.out.log
  fi
fi

if ! is_master "$KEYSTONE_URL" "$MASTER_KEYSTONE_URL" "$KEYSTONE_BRANCH"; then
#keystone_master=is_master "$KEYSTONE_URL" "$MASTER_KEYSTONE_URL" "$KEYSTONE_BRANCH"
#keystone_master=0
#if [ $keystone_master -ne 1 ]; then
  tests_run=1
  cd $TMP_DIR/keystone_source
  ./run_tests.sh -V -f 1>keystone.out.log
  keystone_status=$?
  ./run_tests.sh -V -p 1>keystone_pep8.out.log
  keystone_pep8_status=$?
  if [ "$keystone_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}keystone tests failed "
     grep "Creating venv... done." -m 1 -h -A`wc -l keystone.out.log | cut -d' ' -f1` keystone.out.log
  fi
  
  if [ "$keystone_pep8_status" -ne "0" ]; then
     return_code=1
     return_msg="${return_msg}keystone pep8 failed "
     grep "Running pep8" -m 1 -h -A`wc -l keystone_pep8.out.log | cut -d' ' -f1` keystone_pep8.out.log
  fi
fi

if [ $return_code -ne 0 ]; then
  #return_msg=$return_code
  fail "$return_msg"
fi

if [ $tests_run -eq 0 ]; then
  FAILURE_MSG="Warning: no unit tests run!"
fi
}


setup
run_job
